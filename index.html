<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EBCI Water Quality — E. coli (Rivers & Streams)</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CSV parsing + charts -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- Site config (paths, constants, etc.) -->
  <script src="js/config.js"></script>
</head>

<body>
  <!-- ======================= HEADER ======================= -->
  <header>
    <div class="header-inner">
      <div class="header-logos">
        <img src="assets/natural_resources_logo.png?v=2" alt="EBCI Natural Resources logo" class="logo-img"/>
        <img src="assets/water_logo.png?v=2" alt="EBCI Water Quality logo" class="logo-img"/>
        <img src="assets/phhs_logo.png?v=2" alt="EBCI PHHS logo" class="logo-img"/>
      </div>
      <div class="header-title" style="margin-left:10px">
        <h1>EBCI Water Quality — E. coli (Rivers & Streams)</h1>
        <small class="muted">
          Public transparency dashboard • Last updated:
          <span id="lastUpdated">—</span>
        </small>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- ======================= KPI STRIP ======================= -->
    <div class="kpi">
      <div class="item" id="kpi-total-box">
        <div class="label" id="kpi-total-label">Sites monitored</div>
        <div class="value" id="kpi-total">—</div>
      </div>

      <div class="item" id="kpi-adv-box">
        <div class="label" id="kpi-adv-label">Advisories</div>
        <div class="value" id="kpi-adv">—</div>
      </div>

      <div class="item" id="kpi-cau-box">
        <div class="label" id="kpi-cau-label">Cautions</div>
        <div class="value" id="kpi-cau">—</div>
      </div>
    </div>

    <!-- ======================= LEGEND ======================= -->
    <div class="legend" style="margin:10px 0 6px 0">
      <span class="badge good">Good (below EPA STV and GM)</span>
      <span class="badge caution">Caution (235–409 CFU/100 mL)</span>
      <span class="badge advisory">Advisory (≥410 CFU/100 mL or GM ≥126)</span>
    </div>

    <!-- ======================= MAP + LATEST GRID ======================= -->
    <div class="grid">
      <!-- Map -->
      <div class="card">
        <h2>Map of Sampling Sites</h2>
        <div id="map" class="map"></div>
        <p id="map-note" class="note"></p>
        <p class="note">
          Status uses EPA’s 2012 Recreational Water Quality Criteria for freshwater <i>E. coli</i>
          (GM 126; STV 410 CFU/100 mL). Learn more:
          <a href="https://www.epa.gov/wqc/recreational-water-quality-criteria-and-methods" target="_blank" rel="noopener noreferrer">
            https://www.epa.gov/wqc/recreational-water-quality-criteria-and-methods
          </a>
        </p>

        <!-- Status explainer placed under the EPA note -->
        <div class="status-help" style="margin-top:10px; padding-top:10px; border-top:1px solid #e5e7eb">
          <h3 style="margin:0 0 6px 0; font-size:16px;">How status is determined (EBCI standards)</h3>
          <p class="note" style="font-size:13px;">
            The Eastern Band of Cherokee Indians’ <b>Water Quality Standards (WQS)</b>—adopted under
            <b>Cherokee Code Chapter 113E</b>—designate <b>Recreation</b> and <b>Ceremonial Use</b> for many surface waters.
            For freshwater, the bacteria criteria are:
            <br/>• <b>Geometric mean (GM)</b> of <i>E. coli</i> over a 30-day period ≤ <b>126 CFU/100 mL</b>, and
            <br/>• No more than <b>10%</b> of samples in the same 30-day period exceed <b>410 CFU/100 mL</b>—the
            <b>Statistical Threshold Value (STV)</b>.
            These values align with the U.S. Environmental Protection Agency’s <b>Recreational Water Quality Criteria (RWQC, 2012)</b>.
          </p>
          <ul style="margin:8px 0 0 18px; padding:0; font-size:13px;">
            <li><b>Good</b> — Meets EBCI WQS for Recreation/Ceremonial Use: the site’s <b>30-day GM &lt; 126</b> and the <b>latest sample &lt; 410</b> CFU/100 mL.</li>
            <li><b>Caution</b> — <b>Latest sample 235–409</b> CFU/100 mL (approaching the <b>410</b> STV) while the <b>30-day GM remains &lt; 126</b>. Short-lived spikes often follow rain/runoff; consider postponing water contact for 24–48 hours.</li>
            <li><b>Advisory</b> — Either the <b>latest sample ≥ 410</b> CFU/100 mL or the <b>30-day GM ≥ 126</b>. Avoid swimming/wading where posted; higher-risk groups (young children, older adults, immunocompromised) should take extra care.</li>
          </ul>
          <p class="note" style="font-size:12px; margin-top:8px;">
            <i>Why GM and STV?</i> The <b>GM</b> reflects typical conditions over the last 30 days; the <b>STV (410)</b> controls high single-day results.
            EPA notes that about five samples in 30 days is ideal where feasible.
          </p>
          <p class="note" style="font-size:12px; margin-top:4px;">
            <b>Monitoring frequency.</b> Sites are sampled <b>regularly during the primary recreation season (approximately April–September)</b>
            as staffing, safety, and river conditions allow. Additional sampling may occur after rainfall/runoff or when conditions warrant.
          </p>
        </div>
      </div>

      <!-- Latest Results table -->
      <div class="card">
        <h2>Latest Results</h2>
        <!-- One-line explainer with ≥2-sample GM rule -->
        <p class="note" style="margin-top:-4px;">
          <b>How status is calculated:</b>
          Status uses the <b>latest sample</b> and, when available, the <b>30-day geometric mean (GM)</b>.
          The GM rule applies only when there are <b>&ge;2 samples in the last 30 days</b>.
          <i>Advisory</i> is shown if <b>latest &ge; 410 CFU/100 mL</b> (EPA single-sample
          <b>Statistical Threshold Value, STV</b>) or (when n&ge;2) <b>GM &ge; 126 CFU/100 mL</b>.
          <i>Caution</i> is shown when <b>latest is 235–409 CFU/100 mL</b> and (if computed) <b>GM &lt; 126</b>;
          otherwise <i>Good</i>.
        </p>
        <table id="results" class="table">
          <thead>
            <tr>
              <th>Site</th>
              <th>Waterbody</th>
              <th>Date</th>
              <th>E. coli (CFU/100 mL)</th>
              <th>30-day GM</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="note">
          “GM” = geometric mean of samples in the last 30 days for the site. Non-detects (“&lt;”) are treated as half the
          detection limit; “&gt;” are shown as reported.
        </p>
      </div>
    </div>

    <!-- ======================= SITE TRENDS ======================= -->
    <div class="card" style="margin-top:16px">
      <h2>Site Trends</h2>
      <div class="filter-row">
        <label for="siteFilter">Site:</label>
        <select id="siteFilter"></select>
      </div>
      <div id="siteChart" style="height:540px"></div>
      <p class="note">Choose a specific site or “All sites.” The dashed line indicates the EPA STV (410 CFU/100 mL).</p>
    </div>

    <!-- ======================= GAME (UNDER Site Trends) ======================= -->
    <div class="card" id="gameCard" style="margin-top:16px">
      <h2>Game: River Ranger — E. coli Invaders</h2>
      <div class="game-grid">
        <div class="play">
          <canvas id="ecoliGame" width="780" height="520"></canvas>

          <!-- Start overlay -->
          <div id="gameStart" class="game-overlay">
            <div class="panel">
              <h3>Ready?</h3>
              <div class="small">
                Click to play. Use &larr;/&rarr; to move and hold Space to fire. Clear levels quickly for time bonuses.
              </div>
              <div id="gameStartBtn" class="playbtn">▶</div>
            </div>
          </div>

          <!-- Game over / victory overlay -->
          <div id="gameOverlay" class="game-overlay hidden">
            <div class="panel">
              <h3 id="gameOverlayTitle">Game Over</h3>
              <div>Score</div>
              <div id="gameFinalScore" class="big">0</div>
              <div id="gameVictoryMsg" class="small" style="display:none">
                <b>Way to go — you saved the town from the E. coli outbreak!</b>
              </div>
              <div class="celebrate" id="gameCelebrate">
                <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="60" cy="46" r="16" fill="#80ED99" stroke="#22577A" stroke-width="3"/>
                  <rect x="48" y="62" width="24" height="28" rx="6" fill="#57CC99" stroke="#22577A" stroke-width="3"/>
                </svg>
                <div class="small">Victory dance!</div>
              </div>
              <div class="small" style="margin:6px 0 10px">Enter initials to save your high score.</div>
              <div class="row">
                <input id="gameInitials" class="input" maxlength="3" placeholder="ABC" style="width:80px;text-transform:uppercase" />
                <button id="gameSaveScore" class="btn">Save</button>
                <button id="gameRestart" class="btn secondary">Play again</button>
              </div>
            </div>
          </div>

          <!-- Toast -->
          <div id="gameToast" class="toast"></div>

          <!-- HUD -->
          <div class="hud" style="margin-top:6px">
            <div><b>Score:</b> <span id="gameScore" class="kv">0</span></div>
            <div><b>Lives:</b> <span id="gameLives" class="kv">3</span></div>
            <div><b>Level:</b> <span id="gameLevel" class="kv">1 / 5</span></div>
          </div>
        </div>

        <!-- High scores / description -->
        <div class="side">
          <p>
            <b>About the game:</b> A just-for-fun, Space-Invaders-style mini-game where each “invader”
            represents potential <i>E. coli</i> contamination. Use &larr;/&rarr; to move and hold Space to fire.
            Clear levels quickly to earn time-based bonus points.
          </p>
          <h3>High Scores</h3>
          <table class="table">
            <thead><tr><th>#</th><th>Initials</th><th>Score</th><th>Date</th></tr></thead>
            <tbody id="gameHsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Load game script after the game block -->
    <script src="js/game.js?v=2"></script>

    <!-- ======================= ABOUT & GUIDANCE ======================= -->
    <div class="card" style="margin-top:16px">
      <h2>About the Data & Health Guidance</h2>
      <p><b>What this dashboard shows</b>: culture-based <i>E. coli</i> measurements (CFU/100 mL; MPN/100 mL for Quanti-Tray/Colilert methods) from EBCI rivers and streams to support safe recreation and public transparency.</p>
      <ul>
        <li><b>Why <i>E. coli</i>?</b> It is an indicator of fecal contamination. While most strains are harmless, elevated counts correlate with a higher probability of pathogens that can cause gastrointestinal illness.</li>
        <li><b>How to interpret results</b> (EPA Recreational Water Quality Criteria, 2012):
          <ul>
            <li><b>Geometric Mean (GM)</b>: target ≤ <b>126 CFU/100 mL</b> computed over a 30-day window (EPA recommends ≥5 samples where feasible).</li>
            <li><b>Statistical Threshold Value (STV)</b>: single-sample level <b>410 CFU/100 mL</b>; no more than <b>10%</b> of samples should exceed the STV over the same assessment window.</li>
            <li><b>EBCI status badges</b>: Good (below GM & STV), Caution (235–409), Advisory (≥410 or GM ≥126).</li>
          </ul>
        </li>
        <li><b>When levels are high</b>: After rainfall or runoff events, bacteria often spike for 24–48 hours. Consider postponing swimming/wading, avoid ingesting water, and wash hands before eating.</li>
        <li><b>Higher-risk groups</b>: young children, older adults, pregnant people, and those who are immunocompromised should take extra care.</li>
        <li><b>Data limitations</b>: Single samples are snapshots; conditions change rapidly with weather and flow. The GM smooths noise but requires multiple samples.</li>
      </ul>

      <p><b>Official resources</b>:</p>
      <ul class="resource-list">
        <li>
          Cherokee Code, Chapter 113E – Water Quality:
          <a href="https://library.municode.com/tribes_and_tribal_nations/eastern_band_of_cherokee_indians/codes/code_of_ordinances?nodeId=THCHCO_CH113EWAQUCOTRWA" target="_blank" rel="noopener noreferrer">
            https://library.municode.com/tribes_and_tribal_nations/eastern_band_of_cherokee_indians/codes/code_of_ordinances?nodeId=THCHCO_CH113EWAQUCOTRWA
          </a>
        </li>
        <li>
          EPA Recreational Water Quality Criteria (2012):
          <a href="https://www.epa.gov/wqc/recreational-water-quality-criteria-and-methods" target="_blank" rel="noopener noreferrer">
            https://www.epa.gov/wqc/recreational-water-quality-criteria-and-methods
          </a>
        </li>
        <li>
          EPA <i>E. coli</i> parameter factsheet:
          <a href="https://www.epa.gov/system/files/documents/2021-07/parameter-factsheet_e.-coli.pdf" target="_blank" rel="noopener noreferrer">
            https://www.epa.gov/system/files/documents/2021-07/parameter-factsheet_e.-coli.pdf
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- ======================= FOOTER ======================= -->
  <footer>
    <div class="container">
      <h3>Contact — EBCI Water Quality Team</h3>
      <address>
        <div>
          <strong>Rainee Tetreault</strong><br>
          Email: <a href="mailto:raintetr@ebci-nsn.gov">raintetr@ebci-nsn.gov</a>
          &nbsp;•&nbsp;
          Phone: <a href="tel:+18283596771">828-359-6771</a>
        </div>
        <div style="margin-top:6px">
          <strong>Derek Tahquette</strong><br>
          Email: <a href="mailto:johntahq@ebci-nsn.gov">johntahq@ebci-nsn.gov</a>
          &nbsp;•&nbsp;
          Phone: <a href="tel:+18283596141">828-359-6141</a>
        </div>
      </address>
    </div>
  </footer>

  <!-- ======================= APP SCRIPT ======================= -->
  <script src="js/app.js?v=3"></script>
</body>
</html>
